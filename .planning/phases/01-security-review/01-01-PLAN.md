---
phase: 01-security-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/wp-security-review/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Claude can detect XSS, SQL injection, CSRF, privilege escalation, and file upload vulnerabilities in WordPress code"
    - "Claude reports findings grouped by file with severity (CRITICAL/WARNING/INFO), line numbers, CWE references, and BAD/GOOD code pairs"
    - "Claude distinguishes execution contexts (admin-only, WP-CLI, REST API, public-facing) to avoid false positives"
    - "Claude can run grep-based quick detection from the Search Patterns section"
    - "Claude automatically activates this skill from trigger phrases like 'security review', 'XSS', 'SQL injection'"
  artifacts:
    - path: "skills/wp-security-review/SKILL.md"
      provides: "Complete security review skill with 12 sections matching performance skill structure"
      min_lines: 450
      contains: "name: wp-security-review"
  key_links:
    - from: "skills/wp-security-review/SKILL.md"
      to: "references/*.md"
      via: "Deep-Dive References table"
      pattern: "references/vulnerability-patterns\\.md|references/escaping-guide\\.md|references/sanitization-guide\\.md|references/auth-patterns\\.md|references/nonce-csrf-guide\\.md"
---

<objective>
Create the main SKILL.md for wp-security-review — the core skill file that teaches Claude how to perform WordPress security code reviews.

Purpose: This is the primary deliverable of Phase 1. It defines the complete security review workflow, detection patterns for all major vulnerability categories, context-aware severity assessment, grep patterns for quick triage, output format with CWE references, and references to companion deep-dive docs.

Output: `skills/wp-security-review/SKILL.md` (~500+ lines) with 12 sections mirroring the existing wp-performance-review skill structure.
</objective>

<execution_context>
@/Users/seth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-review/01-CONTEXT.md
@.planning/phases/01-security-review/01-RESEARCH.md
@skills/wp-performance-review/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SKILL.md with YAML frontmatter and 12-section structure</name>
  <files>skills/wp-security-review/SKILL.md</files>
  <action>
Create `skills/wp-security-review/SKILL.md` following the EXACT section structure of the existing `skills/wp-performance-review/SKILL.md` (use it as your structural template) but with security-focused content.

**YAML Frontmatter (SEC-01):**
- `name: wp-security-review`
- `description:` Must include trigger phrases and fit within 1024 characters. Include: "WordPress security code review and vulnerability detection", "security review", "vulnerability", "XSS", "SQL injection", "CSRF", "nonce", "sanitization", "escaping", "capability check", "privilege escalation", "file upload security", "insecure code". Describe what the skill detects (XSS, SQL injection, CSRF, auth bypass, file upload, dangerous functions).

**12 Sections (mirror performance skill layout):**

1. **Overview** — Systematic security code review for WordPress. Core principle: Three-pillar model (sanitize input, validate auth, escape output). Report with line numbers, severity, CWE references.

2. **When to Use / Don't Use** — Use for: security audits, code review for vulnerabilities, pre-launch security check, reviewing AJAX/REST handlers. Don't use for: server hardening, WAF config, performance-only audits, general non-WP PHP.

3. **Code Review Workflow** — 5-step workflow:
   1. Identify file type and apply relevant checks
   2. Scan for CRITICAL patterns first (SQL injection in public code, XSS on unescaped output, missing nonces on state-changing operations)
   3. Check WARNING patterns (auth issues, admin-only XSS, file upload gaps)
   4. Note INFO improvements (defense-in-depth, security constants)
   5. Apply context-aware severity adjustment (admin-only, WP-CLI/cron, REST API, public-facing)
   Report using output format below.

4. **File-Type Specific Checks** — Organized by file type (like performance skill). Cover:
   - **Plugin/Theme PHP files**: Direct file access (ABSPATH), dangerous functions (eval, exec, shell_exec, base64_decode, unserialize), raw $_GET/$_POST without sanitization
   - **Form handlers (admin-post.php, admin_post_*)**: Nonce verification, capability check, input sanitization (the three-step pattern)
   - **AJAX handlers (wp_ajax_*)**: check_ajax_referer(), capability check, sanitize input, wp_ajax_ vs wp_ajax_nopriv_ distinction
   - **REST API endpoints**: permission_callback presence and correctness, __return_true only for public read endpoints, current_user_can() in callbacks
   - **Database code ($wpdb)**: $wpdb->prepare() with placeholders, no direct interpolation, esc_like() for LIKE queries, no double-preparing
   - **Template/output files**: esc_html(), esc_attr(), esc_url(), esc_js() at point of output (late escaping), wp_kses()/wp_kses_post() for rich HTML
   - **File upload handlers**: wp_handle_upload() instead of move_uploaded_file(), MIME type validation, size limits, capability check
   - **JavaScript files**: X-WP-Nonce header for REST API calls, nonce in AJAX POST data

   Each check item includes: pattern to find, severity level, brief explanation.
   Requirements covered: SEC-02 through SEC-18.

5. **Search Patterns for Quick Detection (SEC-20)** — Bash grep commands organized by severity, similar to performance skill. Include patterns for:
   - CRITICAL: `$wpdb->query(` or `$wpdb->get_results(` without `prepare`, `echo $` without escaping function, `move_uploaded_file`, `unserialize($_`, `eval(`, `exec(`, `shell_exec(`, `base64_decode($_`, `register_rest_route` without `permission_callback`
   - WARNING: `$_GET[` or `$_POST[` or `$_REQUEST[` without sanitize_, `wp_ajax_nopriv_` (check has nonce), missing `current_user_can`, `include $_` or `require $_`
   - INFO: missing `defined('ABSPATH')`, `DISALLOW_FILE_EDIT`, `FORCE_SSL_ADMIN`

   Use comments to explain each grep command. These are the patterns the /wp-sec quick scan command will use.

6. **Platform Context** — Notes on managed WordPress hosts (WP VIP, WP Engine, Pantheon) that have additional security layers (WAF, auto-updates, restricted file editing). Note: managed hosts may block dangerous functions at server level, but code should still be written securely for portability.

7. **Quick Reference: Critical Security Patterns** — Organized by vulnerability category with BAD/GOOD code pairs (SEC-21). Cover the 5 deep-coverage areas:
   - XSS Prevention (output escaping) — with context-specific function selection
   - SQL Injection Prevention — $wpdb->prepare() patterns
   - CSRF/Nonce Verification — three-step form handler pattern
   - Authorization/Capability Checks — current_user_can() patterns, REST permission_callback
   - File Upload Security — wp_handle_upload() vs raw move_uploaded_file()
   Plus surface-level patterns:
   - Object Injection — unserialize() dangers, use JSON instead
   - Dangerous Functions — eval, exec, shell_exec flag patterns
   - Direct File Access — ABSPATH check

   ALL code examples MUST follow WordPress PHP Coding Standards: spaces inside parentheses `function_name( $arg )`, use `array()` not `[]`, Yoda conditions `if ( true === $value )`, snake_case, prefixed custom functions.
   ALL code pairs use the ❌ BAD / ✅ GOOD pattern (per user decision).

8. **Severity Definitions (SEC-22)** — Table matching performance skill format but with security-specific definitions:
   - CRITICAL: Exploitable without authentication OR leads to data breach (CWE reference where applicable)
   - WARNING: Exploitable with authentication OR requires specific conditions
   - INFO: Defense-in-depth improvement

9. **Output Format (SEC-23)** — Structure findings report. Per user decision:
   - Group findings by FILE (not by vulnerability category)
   - Each finding includes: line number, severity, issue description, CWE reference, explanation, ❌ BAD / ✅ GOOD code pair with fix
   - Summary at end with total counts by severity

   Format template:
   ```markdown
   ## Security Review: [filename]

   ### Critical Issues
   - **Line X**: [Issue] (CWE-XXX) - [Explanation]
     ❌ `[vulnerable code]`
     ✅ `[fixed code]`

   ### Warnings
   - **Line X**: [Issue] (CWE-XXX) - [Explanation] - [Fix]

   ### Info
   - [Defense-in-depth recommendations]

   ### Summary
   - Total: X Critical, Y Warning, Z Info
   - Risk assessment: [High/Medium/Low]
   ```

10. **Common Mistakes (SEC-24)** — Table of false-positive scenarios to AVOID flagging. Per user decision, must include at minimum:
    - Nonces not required in WP-CLI/cron context
    - wp_kses_post() is valid escaping for trusted content
    - Admin-only $wpdb->query() with hardcoded SQL (no user input = no injection)
    - current_user_can() inside REST permission_callback is correct, not redundant
    Add 4-6 more common false positives from RESEARCH.md pitfalls.

11. **Security Constants Check (SEC-19)** — Brief section on wp-config.php hardening constants: DISALLOW_FILE_EDIT, FORCE_SSL_ADMIN, DISALLOW_UNFILTERED_HTML. Note these are INFO-level recommendations.

12. **Deep-Dive References** — Table linking to companion reference docs (same pattern as performance skill):
    | Task | Reference to Load |
    |------|-------------------|
    | Comprehensive vulnerability catalog | `references/vulnerability-patterns.md` |
    | Output escaping patterns | `references/escaping-guide.md` |
    | Input sanitization patterns | `references/sanitization-guide.md` |
    | Auth and capability checks | `references/auth-patterns.md` |
    | Nonce and CSRF patterns | `references/nonce-csrf-guide.md` |

**Content sourcing:** Use RESEARCH.md extensively — it has verified code examples, CWE mappings, API tables, and patterns. Adapt and organize into the SKILL.md sections, don't just copy wholesale. The SKILL.md should be a concise, actionable review guide, with reference docs handling the deep dives.

**Critical constraint:** The SKILL.md must be SELF-SUFFICIENT for a standard security review. Reference docs add depth but are not required for basic reviews.
  </action>
  <verify>
Verify the file exists and has correct structure:
- File exists at `skills/wp-security-review/SKILL.md`
- YAML frontmatter has `name: wp-security-review` and `description` under 1024 chars
- All 12 sections present (check for ## headings matching the template)
- Code examples use WordPress PHP Coding Standards (spaces in parentheses, array() not [])
- BAD/GOOD pattern used consistently
- CWE references included in code examples and output format
- Severity levels (CRITICAL/WARNING/INFO) used correctly per security definitions
- Search Patterns section has runnable bash grep commands
- Deep-Dive References table lists all 5 reference docs
- File is at least 450 lines
  </verify>
  <done>
SKILL.md exists with all 12 sections, correct frontmatter, context-aware detection patterns for XSS/SQLi/CSRF/auth/file-upload, grep patterns for quick scan, output format with CWE references grouped by file, common false-positive table, and reference doc links. All code examples follow WP PHP Coding Standards with BAD/GOOD pairs.
  </done>
</task>

</tasks>

<verification>
- `skills/wp-security-review/SKILL.md` exists with valid YAML frontmatter
- `name` field is `wp-security-review`
- `description` field is under 1024 characters and includes trigger phrases
- File has 12 major sections matching performance skill structure
- All 5 deep-coverage vulnerability categories have detection patterns and code examples
- Surface-level vulnerabilities (object injection, path traversal, etc.) have scan patterns
- Context-aware detection guidance present (admin, WP-CLI, REST, public)
- Common Mistakes table has at least 8 false-positive scenarios
- Search Patterns section has categorized grep commands
- Output format matches user decision (grouped by file, CWE refs, BAD/GOOD pairs)
</verification>

<success_criteria>
- SKILL.md is a complete, self-sufficient security review guide that Claude can follow
- All SEC requirements mapped to this plan (SEC-01 through SEC-24) are covered
- Structure mirrors wp-performance-review/SKILL.md exactly (12 sections, same ordering)
- A Claude instance could perform a meaningful WordPress security review using ONLY this SKILL.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-review/01-01-SUMMARY.md`
</output>
