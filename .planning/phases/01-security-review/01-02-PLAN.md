---
phase: 01-security-review
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/wp-security-review/references/vulnerability-patterns.md
  - skills/wp-security-review/references/escaping-guide.md
  - skills/wp-security-review/references/sanitization-guide.md
  - skills/wp-security-review/references/auth-patterns.md
  - skills/wp-security-review/references/nonce-csrf-guide.md
autonomous: true

must_haves:
  truths:
    - "Each reference doc provides deep-dive coverage that extends SKILL.md patterns"
    - "Reference docs follow cookbook format: quick reference table + detailed patterns + edge cases + WP nuances"
    - "All code examples follow WordPress PHP Coding Standards with BAD/GOOD pairs"
    - "CWE references are included where applicable"
  artifacts:
    - path: "skills/wp-security-review/references/vulnerability-patterns.md"
      provides: "Comprehensive vulnerability catalog across all categories"
      min_lines: 300
    - path: "skills/wp-security-review/references/escaping-guide.md"
      provides: "Output escaping functions, context-specific escaping, late escaping principle"
      min_lines: 250
    - path: "skills/wp-security-review/references/sanitization-guide.md"
      provides: "Input sanitization functions, validation vs sanitization, type-specific patterns"
      min_lines: 250
    - path: "skills/wp-security-review/references/auth-patterns.md"
      provides: "Capability checks, role hierarchies, meta capabilities, REST permission callbacks"
      min_lines: 250
    - path: "skills/wp-security-review/references/nonce-csrf-guide.md"
      provides: "Nonce lifecycle, form nonces, AJAX nonces, REST nonce header, when nonces are not needed"
      min_lines: 250
  key_links:
    - from: "skills/wp-security-review/references/vulnerability-patterns.md"
      to: "Other reference docs"
      via: "Cross-references to escaping-guide, sanitization-guide, auth-patterns, nonce-csrf-guide"
      pattern: "See.*guide\\.md|See.*patterns\\.md"
---

<objective>
Create the 5 reference documents for wp-security-review — deep-dive companion guides that extend the SKILL.md with comprehensive patterns, edge cases, and WordPress-specific nuances.

Purpose: Reference docs are loaded by Claude on-demand when deeper analysis is needed. They provide the exhaustive pattern catalog that would be too large for SKILL.md itself.

Output: 5 markdown files in `skills/wp-security-review/references/` totaling ~1500+ lines of security guidance.
</objective>

<execution_context>
@/Users/seth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-review/01-CONTEXT.md
@.planning/phases/01-security-review/01-RESEARCH.md
@skills/wp-performance-review/references/anti-patterns.md
@skills/wp-performance-review/references/caching-guide.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vulnerability-patterns.md and escaping-guide.md</name>
  <files>
    skills/wp-security-review/references/vulnerability-patterns.md
    skills/wp-security-review/references/escaping-guide.md
  </files>
  <action>
Create the `references/` directory under `skills/wp-security-review/` if it does not exist.

Use the existing performance skill reference docs (`references/anti-patterns.md`, `references/caching-guide.md`) as STRUCTURAL templates. Match their format: title, quick lookup table, then detailed sections with code examples.

**File 1: vulnerability-patterns.md (SEC-25)**

Comprehensive vulnerability catalog organized by category. Structure:

1. **Quick Lookup Table** — Pattern to find | Severity | CWE | Issue (same format as anti-patterns.md Quick Lookup Table). Include all vulnerability types: XSS (CWE-79), SQL injection (CWE-89), CSRF (CWE-352), missing authorization (CWE-862), incorrect authorization (CWE-863), path traversal (CWE-22), object injection (CWE-502), open redirect, information disclosure, dangerous functions.

2. **SQL Injection Patterns (CWE-89)** — Deep coverage:
   - Direct interpolation in $wpdb methods (get_results, get_var, get_row, query, prepare misuse)
   - LIKE clause injection (missing esc_like)
   - ORDER BY injection (cannot use prepare for identifiers)
   - Double-preparing anti-pattern
   - IN clause construction (safe pattern with array of %s placeholders)
   - Table/column name injection (whitelist approach since prepare doesn't handle identifiers)
   All examples with BAD/GOOD pairs, WordPress PHP Coding Standards.

3. **XSS Patterns (CWE-79)** — Deep coverage:
   - Stored XSS (data from database displayed without escaping)
   - Reflected XSS (direct echo of $_GET/$_POST)
   - DOM-based XSS (JavaScript innerHTML with unescaped data)
   - Context-specific escaping failures (wrong function for context)
   - Late escaping violations (escaping before storage)
   - wp_kses family correct usage (when wp_kses_post is appropriate vs not)

4. **CSRF Patterns (CWE-352)** — Overview with cross-reference:
   - Brief patterns here, point to `nonce-csrf-guide.md` for full coverage
   - Missing nonce in form handlers
   - Missing nonce in AJAX handlers
   - Missing nonce in link-based actions

5. **Authorization Patterns (CWE-862, CWE-863)** — Overview with cross-reference:
   - Brief patterns here, point to `auth-patterns.md` for full coverage
   - Missing capability checks
   - Role-based checks instead of capability checks
   - REST API permission_callback issues

6. **File Upload Vulnerabilities** — Deep coverage:
   - Unrestricted file upload (move_uploaded_file without validation)
   - MIME type spoofing (extension-only checks)
   - Path traversal in upload filenames
   - Missing capability check for uploads
   - PHP in uploads directory execution

7. **Object Injection (CWE-502)** — Surface-level:
   - unserialize() with user input
   - Gadget chain risk overview
   - JSON alternative pattern

8. **Path Traversal (CWE-22)** — Surface-level:
   - Dynamic includes with user input
   - Whitelist approach
   - basename() sanitization

9. **Information Disclosure** — Surface-level:
   - Debug output in production (var_dump, print_r, error_log with sensitive data)
   - Exposed wp-config.php
   - Directory listing
   - PHP error display

10. **Dangerous Function Catalog** — Table of functions to flag:
    - eval(), assert(), preg_replace with /e modifier
    - exec(), shell_exec(), system(), passthru(), popen()
    - base64_decode() on user input
    - unserialize() on user input
    - file_get_contents() with user-controlled URL
    - include/require with user-controlled path

Target: ~400+ lines. Content sourcing: RESEARCH.md has extensive code examples for each category — adapt and organize.

**File 2: escaping-guide.md (SEC-26 — escaping portion)**

Output escaping deep-dive. Structure:

1. **Quick Reference Table** — Function | Output Context | Example | Notes

2. **The Late Escaping Principle** — Explain WordPress's philosophy: sanitize input on receipt, escape output at display. Why: preserves original data for multiple contexts. Common mistake: escaping before storage (double-encoding risk). Include BAD/GOOD pair.

3. **Context-Specific Escaping Functions** — Detailed coverage of each:
   - `esc_html()` — HTML body text. When to use, edge cases (already-encoded entities).
   - `esc_attr()` — HTML attributes. Must use with quoted attributes. Common mistake: using for URLs.
   - `esc_url()` — URLs in href, src, action. Validates scheme (blocks javascript:). Shows why esc_attr is insufficient for URLs.
   - `esc_js()` — Inline JavaScript strings. Rarely needed (prefer wp_localize_script or wp_add_inline_script).
   - `esc_textarea()` — Textarea content. When esc_html is insufficient.
   - `wp_kses()` — HTML whitelist filtering. Custom allowed tags/attributes.
   - `wp_kses_post()` — Post content HTML. When appropriate (trusted content) vs inappropriate (user form input).
   Each with BAD/GOOD code examples and WordPress PHP Coding Standards.

4. **Escaping in Different Contexts** — Patterns for:
   - PHP templates (echo + escape)
   - printf/sprintf (escape inside format args)
   - Heredoc/nowdoc (why they prevent proper escaping — use printf instead)
   - JavaScript localization (wp_localize_script, wp_add_inline_script)
   - REST API responses (generally don't escape — consumers handle display)
   - Shortcode output (must escape — user controls context)

5. **Common Escaping Mistakes** — Detailed patterns:
   - Concatenation before escaping
   - Wrong function for context
   - Escaping before storage
   - Double-escaping (esc_html on already-escaped data)
   - Missing escaping in translated strings (use esc_html__(), esc_attr__())

6. **WordPress i18n + Escaping** — Functions that combine translation and escaping:
   - esc_html__(), esc_html_e(), esc_attr__(), esc_attr_e()
   - wp_kses() on translated strings with HTML

Target: ~300+ lines.
  </action>
  <verify>
- Both files exist in `skills/wp-security-review/references/`
- vulnerability-patterns.md has Quick Lookup Table + sections for each vulnerability category
- escaping-guide.md has Quick Reference Table + Late Escaping Principle + all esc_* functions covered
- All code examples follow WordPress PHP Coding Standards
- BAD/GOOD pattern used consistently
- CWE references present where applicable
- vulnerability-patterns.md is at least 300 lines
- escaping-guide.md is at least 250 lines
  </verify>
  <done>
vulnerability-patterns.md provides comprehensive vulnerability catalog with quick lookup table, deep coverage of SQL injection/XSS/file uploads, surface coverage of object injection/path traversal/info disclosure, and dangerous function catalog. escaping-guide.md covers late escaping principle, all context-specific escaping functions, escaping in different contexts, common mistakes, and i18n+escaping patterns. Both follow cookbook format with BAD/GOOD pairs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sanitization-guide.md, auth-patterns.md, and nonce-csrf-guide.md</name>
  <files>
    skills/wp-security-review/references/sanitization-guide.md
    skills/wp-security-review/references/auth-patterns.md
    skills/wp-security-review/references/nonce-csrf-guide.md
  </files>
  <action>
Continue using the performance skill reference docs as structural templates.

**File 3: sanitization-guide.md (SEC-26 — sanitization portion)**

Input sanitization deep-dive. Structure:

1. **Quick Reference Table** — Function | Input Type | Returns | When to Use

2. **Sanitization vs Validation** — Key distinction: sanitization CLEANS data (removes bad), validation CHECKS data (rejects bad). Show when to use each. WordPress provides both patterns.

3. **Type-Specific Sanitization Functions** — Detailed coverage:
   - `sanitize_text_field()` — General text. What it strips (tags, octets, line breaks, extra whitespace).
   - `sanitize_textarea_field()` — Multiline text. Preserves line breaks unlike sanitize_text_field.
   - `sanitize_email()` — Email addresses. Returns valid email or empty string.
   - `sanitize_url()` / `esc_url_raw()` — URLs for database storage (not display — that's esc_url).
   - `sanitize_file_name()` — File names. Removes special characters, spaces to dashes.
   - `sanitize_key()` — Keys/slugs. Lowercase alphanumeric + underscore/dash.
   - `sanitize_title()` — Titles for URLs. Different from sanitize_text_field.
   - `sanitize_html_class()` — CSS class names.
   - `absint()` / `intval()` — Integer sanitization.
   - `floatval()` — Float sanitization.
   - `wp_unslash()` — Remove WordPress magic quotes before sanitizing (critical step often missed).
   Each with BAD/GOOD code pair showing raw $_POST/$_GET vs sanitized.

4. **Sanitizing Arrays and Complex Data** — Patterns for:
   - Array of values from $_POST (array_map with sanitize function)
   - Nested arrays (recursive sanitization)
   - JSON payloads (json_decode then sanitize individual fields)
   - Checkbox/select values (validate against whitelist)

5. **When NOT to Sanitize** — Important edge cases:
   - Post content (use wp_kses_post instead, or let WP handle via wp_insert_post)
   - Binary data / file contents (use file validation instead)
   - Data already from trusted WordPress functions (avoid double-sanitizing)

6. **The wp_unslash() Requirement** — WordPress adds magic quotes to superglobals. Must call wp_unslash() BEFORE sanitizing or data will have incorrect slashes. Show pattern:
   ```php
   $value = sanitize_text_field( wp_unslash( $_POST['field'] ) );
   ```

Target: ~300+ lines.

**File 4: auth-patterns.md (SEC-27)**

Authorization and authentication deep-dive. Structure:

1. **Quick Reference Table** — Function | Purpose | Use Case

2. **Capabilities vs Roles** — Why use capabilities not roles. WordPress role hierarchy. Meta capabilities vs primitive capabilities. Show role check anti-pattern vs capability check.

3. **Common Capability Checks** — Organized by operation type:
   - Content management: edit_posts, edit_others_posts, publish_posts, delete_posts, edit_post (meta), delete_post (meta)
   - User management: create_users, edit_users, delete_users, promote_users, edit_user (meta)
   - Plugin/theme management: activate_plugins, install_plugins, edit_plugins, switch_themes
   - Site management: manage_options, manage_categories, moderate_comments, upload_files
   Each with code example showing proper check pattern.

4. **REST API Permission Callbacks** — Deep coverage:
   - permission_callback requirement (WP 5.5+)
   - Public endpoints (__return_true — when appropriate)
   - Authenticated endpoints (current_user_can in closure)
   - Context-aware authorization (checking ownership with meta capabilities)
   - Multiple method endpoints (different permissions per method)
   - Combining nonce + capability check for cookie auth
   All with BAD/GOOD pairs.

5. **AJAX Handler Authorization** — Patterns for:
   - wp_ajax_ hooks (already authenticated, need capability check)
   - wp_ajax_nopriv_ hooks (unauthenticated — higher risk)
   - When to register nopriv (public features only)
   - Capability check pattern in AJAX handlers

6. **Custom Capabilities** — Brief coverage:
   - register_post_type with capability_type
   - map_meta_cap for custom post types
   - When to create custom capabilities vs use built-in

7. **Common Authorization Mistakes** — Table format:
   - Checking is_user_logged_in() instead of current_user_can()
   - Using role names instead of capabilities
   - Missing auth check in admin-post.php handlers
   - __return_true for write/delete endpoints
   - Forgetting permission_callback entirely

Target: ~300+ lines.

**File 5: nonce-csrf-guide.md**

CSRF protection with WordPress nonces deep-dive. Structure:

1. **Quick Reference Table** — Function | Purpose | Returns | Use Case

2. **Nonce Lifecycle** — How WordPress nonces work:
   - Created with wp_create_nonce() — tied to action, user, and time
   - Valid for 12-24 hours (two 12-hour ticks)
   - Different nonce for each logged-in user
   - Not cryptographic nonces (misnomer) — they're CSRF tokens

3. **Form Nonces** — Complete pattern:
   - wp_nonce_field() in form HTML
   - wp_verify_nonce() in handler
   - check_admin_referer() for admin form handlers (dies on failure)
   - Full three-step handler example (nonce + capability + sanitize)

4. **AJAX Nonces** — Complete pattern:
   - wp_create_nonce() localized via wp_localize_script()
   - Sent in POST data or custom header
   - check_ajax_referer() in wp_ajax_* handler
   - jQuery.post and fetch() examples for frontend

5. **URL Nonces** — For link-based actions:
   - wp_nonce_url() to add nonce to URL
   - wp_verify_nonce() with $_GET in handler
   - Common use: delete/toggle actions via links

6. **REST API Nonces** — Different model:
   - Cookie auth requires X-WP-Nonce header = wp_create_nonce('wp_rest')
   - Application passwords / OAuth don't need nonces
   - JavaScript setup pattern with wp_localize_script or inline script

7. **When Nonces Are NOT Needed** — Critical for avoiding false positives:
   - WP-CLI commands (no HTTP = no CSRF)
   - WP-Cron callbacks (server-initiated)
   - REST API with application passwords / OAuth
   - Public read-only operations (GET requests without state change)

8. **Nonce Debugging** — Common issues:
   - Nonce action mismatch (create vs verify must match string)
   - Nonce field name mismatch
   - Expired nonce (user on page > 12 hours)
   - Caching plugins caching nonce values (stale nonces)

Target: ~300+ lines.

**Content sourcing for all three files:** RESEARCH.md has verified patterns and code examples for each area. Adapt into cookbook format. Ensure all code follows WordPress PHP Coding Standards.
  </action>
  <verify>
- All 3 files exist in `skills/wp-security-review/references/`
- sanitization-guide.md covers all sanitize_* functions with BAD/GOOD pairs
- auth-patterns.md covers capabilities, REST API permissions, AJAX authorization
- nonce-csrf-guide.md covers form/AJAX/URL/REST nonces and when nonces are NOT needed
- Each file has a Quick Reference Table at the top
- All code examples follow WordPress PHP Coding Standards
- Each file is at least 250 lines
- Files reference each other where appropriate (cross-linking)
  </verify>
  <done>
sanitization-guide.md covers all input sanitization functions with type-specific guidance, wp_unslash() requirement, array sanitization, and when not to sanitize. auth-patterns.md covers capability vs role model, common capabilities by operation type, REST API permission callbacks, AJAX authorization, and custom capabilities. nonce-csrf-guide.md covers nonce lifecycle, form/AJAX/URL/REST nonce patterns, when nonces are not needed, and nonce debugging. All follow cookbook format with BAD/GOOD pairs and cross-references.
  </done>
</task>

</tasks>

<verification>
- All 5 reference files exist in `skills/wp-security-review/references/`
- Each file has a Quick Reference/Lookup Table as the first content section
- Total content across 5 files is at least 1300 lines
- All code examples follow WordPress PHP Coding Standards
- CWE references included where applicable
- BAD/GOOD pattern used throughout
- Files cross-reference each other where appropriate
- Content aligns with what SKILL.md Deep-Dive References table will point to
</verification>

<success_criteria>
- 5 reference docs provide comprehensive deep-dive coverage for all security topics
- Each doc follows cookbook format (quick table + patterns + edge cases + WP nuances)
- A Claude instance can load any reference doc to get deeper guidance on that security area
- Content extends SKILL.md without duplicating it (SKILL.md = concise patterns, refs = exhaustive catalog)
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-review/01-02-SUMMARY.md`
</output>
